SET SQLFORMAT CSV;
SET TERM OFF;
SET VERIFY OFF;
SET FEEDBACK OFF;
SET TRIMSPOOL ON;
-- take name from argument 1
DEFINE OUTFILE = '&1'

-- take period from argument 2 and 3
DEFINE WEF = '&2'
DEFINE TIL = '&3'

SPOOL '&OUTFILE';



WITH data AS (
SELECT * FROM PRUDEV.V_PRU_FAC_TDC_DD
WHERE ENTRY_DATE >= '&WEF' AND ENTRY_DATE <'&TIL'
)

SELECT
  TO_CHAR(ENTRY_DATE,'YYYY') AS YEAR,
  EXTRACT (MONTH FROM ENTRY_DATE) MONTH_NUM, TO_CHAR(ENTRY_DATE,'MON') AS MONTH_MON,
  ENTRY_DATE AS FLT_DATE,
  CASE UNIT_NAME
       WHEN 'SES Performance Scheme SES-RP2 based on FIR' THEN 'SES Area (RP2)'
  END ENTITY_NAME,
  'AREA (FIR)' AS ENTITY_TYPE,
  TTF_FLT AS FLT_ERT_1,
  TDM_ERT AS DLY_ERT_1,
  TDM_ERT_A AS DLY_ERT_A_1,
  TDM_ERT_C AS DLY_ERT_C_1,
  TDM_ERT_D AS DLY_ERT_D_1,
  TDM_ERT_E AS DLY_ERT_E_1,
  TDM_ERT_G AS DLY_ERT_G_1,
  TDM_ERT_I AS DLY_ERT_I_1,
  TDM_ERT_M AS DLY_ERT_M_1,
  TDM_ERT_N AS DLY_ERT_N_1,
  TDM_ERT_O AS DLY_ERT_O_1,
  TDM_ERT_P AS DLY_ERT_P_1,
  TDM_ERT_R AS DLY_ERT_R_1,
  TDM_ERT_S AS DLY_ERT_S_1,
  TDM_ERT_T AS DLY_ERT_T_1,
  TDM_ERT_V AS DLY_ERT_V_1,
  TDM_ERT_W AS DLY_ERT_W_1,
  TDM_ERT_NA AS DLY_ERT_NA_1,
  TDF_ERT AS FLT_ERT_1_DLY,
  TDF_15_ERT AS FLT_ERT_1_DLY_15
FROM data
WHERE
  (UNIT_PRU_TYPE = 'ZONE_FIR' AND UNIT_ID IN (56)) AND
  (ENTRY_DATE >= '1-JAN-2015' AND ENTRY_DATE < '1-JAN-2020')

UNION ALL

SELECT
  TO_CHAR(ENTRY_DATE,'YYYY') AS YEAR,
  EXTRACT (MONTH FROM ENTRY_DATE) MONTH_NUM, TO_CHAR(ENTRY_DATE,'MON') AS MONTH_MON,
  ENTRY_DATE AS FLT_DATE,
  UNIT_NAME AS ENTITY_NAME,
  'FAB (FIR)' AS ENTITY_TYPE,
  TTF_FLT AS FLT_ERT_1,
  TDM_ERT AS DLY_ERT_1,
  TDM_ERT_A AS DLY_ERT_A_1,
  TDM_ERT_C AS DLY_ERT_C_1,
  TDM_ERT_D AS DLY_ERT_D_1,
  TDM_ERT_E AS DLY_ERT_E_1,
  TDM_ERT_G AS DLY_ERT_G_1,
  TDM_ERT_I AS DLY_ERT_I_1,
  TDM_ERT_M AS DLY_ERT_M_1,
  TDM_ERT_N AS DLY_ERT_N_1,
  TDM_ERT_O AS DLY_ERT_O_1,
  TDM_ERT_P AS DLY_ERT_P_1,
  TDM_ERT_R AS DLY_ERT_R_1,
  TDM_ERT_S AS DLY_ERT_S_1,
  TDM_ERT_T AS DLY_ERT_T_1,
  TDM_ERT_V AS DLY_ERT_V_1,
  TDM_ERT_W AS DLY_ERT_W_1,
  TDM_ERT_NA AS DLY_ERT_NA_1,
  TDF_ERT AS FLT_ERT_1_DLY,
  TDF_15_ERT AS FLT_ERT_1_DLY_15
FROM data
WHERE
  UNIT_PRU_TYPE = 'FAB_FIR' AND
  UNIT_NAME NOT IN ('BLUE MED FAB (+Albania)') AND
  ENTRY_DATE >= '1-JAN-2015'

UNION ALL

SELECT
  TO_CHAR(ENTRY_DATE,'YYYY') AS YEAR,
  EXTRACT (MONTH FROM ENTRY_DATE) MONTH_NUM, TO_CHAR(ENTRY_DATE,'MON') AS MONTH_MON,
  ENTRY_DATE AS FLT_DATE,
  UNIT_NAME AS ENTITY_NAME,
  'COUNTRY (FIR)' AS ENTITY_TYPE,
  TTF_FLT AS FLT_ERT_1,
  TDM_ERT AS DLY_ERT_1,
  TDM_ERT_A AS DLY_ERT_A_1,
  TDM_ERT_C AS DLY_ERT_C_1,
  TDM_ERT_D AS DLY_ERT_D_1,
  TDM_ERT_E AS DLY_ERT_E_1,
  TDM_ERT_G AS DLY_ERT_G_1,
  TDM_ERT_I AS DLY_ERT_I_1,
  TDM_ERT_M AS DLY_ERT_M_1,
  TDM_ERT_N AS DLY_ERT_N_1,
  TDM_ERT_O AS DLY_ERT_O_1,
  TDM_ERT_P AS DLY_ERT_P_1,
  TDM_ERT_R AS DLY_ERT_R_1,
  TDM_ERT_S AS DLY_ERT_S_1,
  TDM_ERT_T AS DLY_ERT_T_1,
  TDM_ERT_V AS DLY_ERT_V_1,
  TDM_ERT_W AS DLY_ERT_W_1,
  TDM_ERT_NA AS DLY_ERT_NA_1,
  TDF_ERT AS FLT_ERT_1_DLY,
  TDF_15_ERT AS FLT_ERT_1_DLY_15
FROM data
WHERE
  UNIT_PRU_TYPE = 'COUNTRY_FIR' AND
  (UNIT_CODE  IN (SELECT
                    COUNTRY_ICAO_CODE
                  FROM V_PRU_REL_COUNTRY_ZONE
                  WHERE ZONE_ID = 58) OR
   UNIT_CODE IN ('EG_CT', 'EG_OC', 'LEGC', 'LP_CT', 'LP_OC')) AND
  -- just because did not calculate further back in time
  ENTRY_DATE >= '01-JAN-2013'
ORDER BY 4,5;

SPOOL OFF;
QUIT
